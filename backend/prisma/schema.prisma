generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS
enum driver_status {
  available
  on_route
  break
  offline
}

enum document_type {
  license
  passport
  medical
  contract
}

enum shift_status {
  scheduled
  active
  completed
  cancelled
}

enum device_type {
  phone
  tablet
  gps_tracker
}

enum order_status {
  pending
  confirmed
  assigned
  in_transit
  arrived
  delivered
  failed
  cancelled
}

enum route_status {
  planned
  active
  completed
  cancelled
}

enum route_point_status {
  pending
  arrived
  completed
  skipped
}

enum alert_type {
  accident
  breakdown
  delay
  sos
  zone_exit
  battery_low
  delivery_failed
  route_deviation
}

enum alert_severity {
  info
  warning
  critical
}

enum activity_action {
  create
  update
  delete
  assign
  status_change
}

// MODELS
model drivers {
  id            String            @id @default(uuid()) @db.Uuid @map("id")
  name          String            @db.VarChar(255) @map("name")
  phone         String            @db.VarChar(50) @map("phone")
  email         String?           @db.VarChar(255) @map("email")
  licenseNumber String?           @db.VarChar(100) @map("license_number")
  status        driver_status     @default(available) @map("status")
  createdAt     DateTime          @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt     DateTime          @updatedAt @db.Timestamptz(6) @map("updated_at")
  isActive      Boolean           @default(true) @map("is_active")
  notes         String?           @db.Text @map("notes")

  documents     driver_documents[]
  shifts        driver_shifts[]
  driver_zones  driver_zones[]
  orders        orders[]
  routes        routes[]

  @@map("drivers")
}

model driver_documents {
  id            String        @id @default(uuid()) @db.Uuid @map("id")
  driverId     String        @db.Uuid @map("driver_id")
  documentType document_type @map("document_type")
  documentNumber String?     @db.VarChar(100) @map("document_number")
  issueDate    DateTime?     @db.Date @map("issue_date")
  expiryDate   DateTime?     @db.Date @map("expiry_date")
  fileUrl      String?       @db.Text @map("file_url")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime      @updatedAt @db.Timestamptz(6) @map("updated_at")

  driver        drivers       @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_documents")
}

model driver_shifts {
  id            String        @id @default(uuid()) @db.Uuid @map("id")
  driverId     String        @db.Uuid @map("driver_id")
  startTime    DateTime      @db.Timestamptz(6) @map("start_time")
  endTime      DateTime?     @db.Timestamptz(6) @map("end_time")
  status        shift_status  @default(scheduled) @map("status")
  notes         String?       @db.Text @map("notes")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime      @updatedAt @db.Timestamptz(6) @map("updated_at")

  driver        drivers       @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@map("driver_shifts")
}

model driver_zones {
  id            String        @id @default(uuid()) @db.Uuid @map("id")
  driverId     String        @db.Uuid @map("driver_id")
  zoneId       String        @db.Uuid @map("zone_id")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")

  driver        drivers       @relation(fields: [driverId], references: [id], onDelete: Cascade)
  zone          zones         @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@unique([driverId, zoneId])
  @@map("driver_zones")
}

model devices {
  id            String            @id @default(uuid()) @db.Uuid @map("id")
  imei          String            @unique @db.VarChar(50) @map("imei")
  deviceType   device_type       @map("device_type")
  name          String            @db.VarChar(255) @map("name")
  model         String?           @db.VarChar(100) @map("model")
  driverId     String?           @db.Uuid @map("driver_id")
  isActive     Boolean           @default(true) @map("is_active")
  batteryLevel Int?              @db.SmallInt @map("battery_level")
  lastSeen     DateTime?         @db.Timestamptz(6) @map("last_seen")
  createdAt    DateTime          @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime          @updatedAt @db.Timestamptz(6) @map("updated_at")
  notes         String?           @db.Text @map("notes")

  locations     device_locations[]

  @@map("devices")
}

model device_locations {
  id            String        @id @default(uuid()) @db.Uuid @map("id")
  deviceId     String        @db.Uuid @map("device_id")
  latitude      Decimal       @db.Decimal(10, 8) @map("latitude")
  longitude     Decimal       @db.Decimal(11, 8) @map("longitude")
  speed         Decimal?      @db.Decimal(6, 2) @map("speed")
  heading       Int?          @db.SmallInt @map("heading")
  accuracy      Decimal?      @db.Decimal(6, 2) @map("accuracy")
  timestamp     DateTime      @db.Timestamptz(6) @map("timestamp")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")

  device        devices       @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@map("device_locations")
}

model zones {
  id            String          @id @default(uuid()) @db.Uuid @map("id")
  name          String          @db.VarChar(255) @map("name")
  description   String?         @db.Text @map("description")
  polygonCoords Json?          @db.JsonB @map("polygon_coords")
  centerLat    Decimal?        @db.Decimal(10, 8) @map("center_lat")
  centerLng    Decimal?        @db.Decimal(11, 8) @map("center_lng")
  radius        Decimal?        @db.Decimal(10, 2) @map("radius")
  isActive     Boolean         @default(true) @map("is_active")
  createdAt    DateTime        @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime        @updatedAt @db.Timestamptz(6) @map("updated_at")

  driver_zones  driver_zones[]

  @@map("zones")
}

model addresses {
  id            String        @id @default(uuid()) @db.Uuid @map("id")
  street        String        @db.VarChar(255) @map("street")
  city          String        @db.VarChar(100) @map("city")
  state         String?       @db.VarChar(100) @map("state")
  postalCode   String?       @db.VarChar(20) @map("postal_code")
  country       String        @default("RU") @db.VarChar(100) @map("country")
  latitude      Decimal?      @db.Decimal(10, 8) @map("latitude")
  longitude     Decimal?      @db.Decimal(11, 8) @map("longitude")
  buildingNumber String?     @db.VarChar(50) @map("building_number")
  apartment     String?       @db.VarChar(50) @map("apartment")
  notes         String?       @db.Text @map("notes")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime      @updatedAt @db.Timestamptz(6) @map("updated_at")
  isActive     Boolean       @default(true) @map("is_active")

  orders        orders[]
  route_points  route_points[]

  @@map("addresses")
}

model orders {
  id                    String                @id @default(uuid()) @db.Uuid @map("id")
  orderNumber          String                @unique @db.VarChar(100) @map("order_number")
  driverId             String?               @db.Uuid @map("driver_id")
  addressId            String                @db.Uuid @map("address_id")
  status                order_status          @default(pending) @map("status")
  totalAmount          Decimal               @db.Decimal(10, 2) @map("total_amount")
  deliveryFee          Decimal?              @db.Decimal(10, 2) @map("delivery_fee")
  scheduledDelivery    DateTime?             @db.Timestamptz(6) @map("scheduled_delivery")
  actualDelivery       DateTime?             @db.Timestamptz(6) @map("actual_delivery")
  notes                 String?               @db.Text @map("notes")
  createdAt            DateTime              @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt            DateTime              @updatedAt @db.Timestamptz(6) @map("updated_at")
  customerName         String?               @db.VarChar(255) @map("customer_name")
  customerPhone        String?               @db.VarChar(50) @map("customer_phone")

  driver                drivers?              @relation(fields: [driverId], references: [id], onDelete: SetNull)
  address               addresses             @relation(fields: [addressId], references: [id], onDelete: Restrict)
  items                 order_items[]
  status_history        order_status_history[]

  @@map("orders")
}

model order_items {
  id            String        @id @default(uuid()) @db.Uuid @map("id")
  orderId      String        @db.Uuid @map("order_id")
  name          String        @db.VarChar(255) @map("name")
  quantity      Int           @default(1) @map("quantity")
  unitPrice    Decimal       @db.Decimal(10, 2) @map("unit_price")
  totalPrice   Decimal       @db.Decimal(10, 2) @map("total_price")
  notes         String?       @db.Text @map("notes")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")

  order         orders        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model order_status_history {
  id            String        @id @default(uuid()) @db.Uuid @map("id")
  orderId      String        @db.Uuid @map("order_id")
  status        order_status  @map("status")
  changedBy    String?       @db.VarChar(255) @map("changed_by")
  notes         String?       @db.Text @map("notes")
  createdAt    DateTime      @default(now()) @db.Timestamptz(6) @map("created_at")

  order         orders        @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_status_history")
}

model routes {
  id            String            @id @default(uuid()) @db.Uuid @map("id")
  routeNumber  String            @unique @db.VarChar(100) @map("route_number")
  driverId     String            @db.Uuid @map("driver_id")
  status        route_status      @default(planned) @map("status")
  plannedStart DateTime          @db.Timestamptz(6) @map("planned_start")
  actualStart  DateTime?         @db.Timestamptz(6) @map("actual_start")
  plannedEnd   DateTime?         @db.Timestamptz(6) @map("planned_end")
  actualEnd    DateTime?         @db.Timestamptz(6) @map("actual_end")
  totalDistance Decimal?         @db.Decimal(10, 2) @map("total_distance")
  totalDuration Int?             @db.Integer @map("total_duration")
  notes         String?           @db.Text @map("notes")
  createdAt    DateTime          @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime          @updatedAt @db.Timestamptz(6) @map("updated_at")

  driver        drivers           @relation(fields: [driverId], references: [id], onDelete: Restrict)
  points        route_points[]

  @@map("routes")
}

model route_points {
  id            String              @id @default(uuid()) @db.Uuid @map("id")
  routeId      String              @db.Uuid @map("route_id")
  addressId    String              @db.Uuid @map("address_id")
  sequence      Int                 @default(0) @map("sequence")
  status        route_point_status  @default(pending) @map("status")
  plannedArrival DateTime?         @db.Timestamptz(6) @map("planned_arrival")
  actualArrival  DateTime?         @db.Timestamptz(6) @map("actual_arrival")
  notes         String?             @db.Text @map("notes")
  createdAt    DateTime            @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime            @updatedAt @db.Timestamptz(6) @map("updated_at")

  route         routes              @relation(fields: [routeId], references: [id], onDelete: Cascade)
  address       addresses           @relation(fields: [addressId], references: [id], onDelete: Restrict)

  @@map("route_points")
}

model alerts {
  id            String          @id @default(uuid()) @db.Uuid @map("id")
  alertType    alert_type      @map("alert_type")
  severity      alert_severity  @default(info) @map("severity")
  title         String          @db.VarChar(255) @map("title")
  message       String          @db.Text @map("message")
  driverId     String?         @db.Uuid @map("driver_id")
  deviceId     String?         @db.Uuid @map("device_id")
  orderId      String?         @db.Uuid @map("order_id")
  routeId      String?         @db.Uuid @map("route_id")
  isRead       Boolean         @default(false) @map("is_read")
  isResolved   Boolean         @default(false) @map("is_resolved")
  resolvedAt   DateTime?       @db.Timestamptz(6) @map("resolved_at")
  resolvedBy   String?         @db.VarChar(255) @map("resolved_by")
  metadata      Json?           @db.JsonB @map("metadata")
  createdAt    DateTime        @default(now()) @db.Timestamptz(6) @map("created_at")
  updatedAt    DateTime        @updatedAt @db.Timestamptz(6) @map("updated_at")

  @@map("alerts")
}

model activity_logs {
  id            String            @id @default(uuid()) @db.Uuid @map("id")
  action        activity_action  @map("action")
  entityType   String            @db.VarChar(100) @map("entity_type")
  entityId     String            @db.VarChar(255) @map("entity_id")
  userId       String?           @db.VarChar(255) @map("user_id")
  description   String?           @db.Text @map("description")
  metadata      Json?             @db.JsonB @map("metadata")
  ipAddress    String?           @db.VarChar(50) @map("ip_address")
  userAgent    String?           @db.Text @map("user_agent")
  createdAt    DateTime          @default(now()) @db.Timestamptz(6) @map("created_at")

  @@map("activity_logs")
}